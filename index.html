<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tomar y subir foto (mobile)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--accent:#0066cc;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:var(--bg); margin:0; padding:20px; color:#111}
    .container{max-width:720px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:1.1rem;margin:0}
    p.lead{margin:6px 0 18px;color:var(--muted);font-size:.95rem}

    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06);padding:16px}
    .file-row{display:flex;gap:8px;flex-wrap:wrap}
    .file-row > *{flex:1 1 180px}

    input[type=file]{display:block;width:100%}
    .preview{margin-top:12px;border-radius:10px;overflow:hidden;border:1px solid #e6e9ef;background:#fafafa;display:flex;align-items:center;justify-content:center;height:320px}
    .preview img{max-width:100%;max-height:100%;object-fit:contain}

    .controls{display:flex;gap:8px;margin-top:12px}
    button{appearance:none;border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;font-weight:600}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #dbe6f6}
    .muted{color:var(--muted);font-size:.9rem}

    progress{width:100%;height:12px;border-radius:8px;overflow:hidden}
    .info{margin-top:10px;font-size:.9rem;color:var(--muted)}

    @media(min-width:640px){h1{font-size:1.25rem}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Tomar y subir foto (mobile)</h1>
    </header>
    <p class="lead">Toma una foto desde el celular (o selecciona una imagen), verás el preview y podrás enviarla a un webhook de Make (Integromat).</p>

    <div class="card">
      <div class="file-row">
        <!-- "capture" sugiere usar la cámara en mobile -->
        <div>
          <label class="muted">Foto (cámara / galería)</label>
          <input id="fileInput" type="file" accept="image/*" capture="environment" />
        </div>
        <div>
          <label class="muted">Nombre (opcional)</label>
          <input id="nameInput" type="text" placeholder="Ej: foto_entrega_01" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef" />
        </div>
      </div>

      <div class="preview" id="preview">
        <div class="muted">No hay imagen seleccionada</div>
      </div>

      <div class="controls">
        <button id="uploadBtn" disabled>Subir foto</button>
        <button id="clearBtn" class="secondary">Limpiar</button>
      </div>

      <div class="info" id="info">Tamaño: — &middot; Tipo: —</div>
      <div style="margin-top:10px;display:none" id="progressWrap">
        <progress id="progress" value="0" max="100"></progress>
      </div>
      <div id="result" class="info" style="margin-top:8px"></div>

      <div style="margin-top:12px;color:#9aa3b2;font-size:.85rem">Nota: reemplace la constante <code>WEBHOOK_URL</code> dentro del script por la URL de su webhook de Make.</div>
    </div>
  </div>

<script>
// === CONFIG: reemplaza esto con tu webhook de Make/Integromat ===
const WEBHOOK_URL = 'https://hook.us2.make.com/v5elvrnssr8b7r5x8taniadw2nene7nn';
// =================================================================

const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const uploadBtn = document.getElementById('uploadBtn');
const clearBtn = document.getElementById('clearBtn');
const info = document.getElementById('info');
const nameInput = document.getElementById('nameInput');
const progress = document.getElementById('progress');
const progressWrap = document.getElementById('progressWrap');
const result = document.getElementById('result');

let currentFile = null;

fileInput.addEventListener('change', async (ev) => {
  const file = ev.target.files && ev.target.files[0];
  result.textContent = '';
  if (!file) return resetPreview();

  // Verificación básica
  if (!file.type.startsWith('image/')) { alert('Por favor selecciona una imagen.'); resetPreview(); return; }

  // Guarda referencia y muestra preview
  currentFile = file;
  showPreview(file);
  uploadBtn.disabled = false;
  info.textContent = `Tamaño: ${formatBytes(file.size)} · Tipo: ${file.type}`;
});

clearBtn.addEventListener('click', (ev) => { ev.preventDefault(); fileInput.value = ''; resetPreview(); });

uploadBtn.addEventListener('click', async (ev) => {
  ev.preventDefault();
  if (!currentFile) return alert('No hay imagen para subir.');
  uploadBtn.disabled = true;
  progressWrap.style.display = '';
  progress.value = 0;
  result.textContent = '';

  try {
    // Opcional: reducir tamaño antes de subir (canvas) para ahorrar datos
    const blobToSend = await resizeImageIfNeeded(currentFile, 1024, 0.8);

    const form = new FormData();
    // Nombre del archivo: usa el nombre ingresado si existe
    const fileName = (nameInput.value || 'photo') + '.' + (blobToSend.type.split('/')[1] || 'jpg');
    form.append('file', blobToSend, fileName);
    form.append('filename', fileName);
    form.append('originalName', currentFile.name);
    form.append('size', String(blobToSend.size));

    // Si Make espera JSON, puedes enviar también una versión en base64 (descomentar block si lo necesitas)
    // const base64 = await blobToBase64(blobToSend);
    // form.append('data_url', base64);

    // Envío por fetch con progreso (usar XHR para ver progreso real)
    await sendWithXhr(WEBHOOK_URL, form, (pct) => { progress.value = pct; });

    result.style.color = 'green';
    result.textContent = 'Envío completado correctamente.';
  } catch (err) {
    console.error(err);
    result.style.color = 'crimson';
    result.textContent = 'Error al subir: ' + (err.message || err);
  } finally {
    uploadBtn.disabled = false;
    progressWrap.style.display = 'none';
  }
});

function resetPreview(){
  currentFile = null;
  preview.innerHTML = '<div class="muted">No hay imagen seleccionada</div>';
  uploadBtn.disabled = true;
  info.textContent = 'Tamaño: — · Tipo: —';
  result.textContent = '';
}

function showPreview(file){
  preview.innerHTML = '';
  const img = document.createElement('img');
  img.alt = 'preview';
  img.src = URL.createObjectURL(file);
  preview.appendChild(img);
  // liberar URL cuando la imagen haya cargado
  img.onload = () => URL.revokeObjectURL(img.src);
}

function formatBytes(bytes, decimals = 2) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const dm = decimals < 0 ? 0 : decimals;
  const sizes = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

// Redimensiona imagen si supera maxWidth (mantiene proporción)
async function resizeImageIfNeeded(file, maxWidth = 1024, quality = 0.8){
  if (!file.type.startsWith('image/')) return file;
  // Si ya es pequeña, no tocar
  if (file.size < 300*1024) return file; // menos de ~300KB -> no comprimir

  const img = await createImageBitmap(file);
  const ratio = img.width / img.height;
  const targetWidth = Math.min(img.width, maxWidth);
  const targetHeight = Math.round(targetWidth / ratio);

  const canvas = document.createElement('canvas');
  canvas.width = targetWidth;
  canvas.height = targetHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  return await new Promise((res) => canvas.toBlob((blob) => {
    // Si blob es null (rara vez), devuelvo original
    if (!blob) return res(file);
    res(blob);
  }, 'image/jpeg', quality));
}

function blobToBase64(blob){
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(blob);
  });
}

// Envío con XHR para poder reportar progreso
function sendWithXhr(url, formData, onProgress){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);

    xhr.upload.onprogress = function(e){
      if (!e.lengthComputable) return;
      const pct = Math.round((e.loaded / e.total) * 100);
      if (typeof onProgress === 'function') onProgress(pct);
    };

    xhr.onload = function(){
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve(xhr.responseText);
      } else {
        reject(new Error('Status ' + xhr.status + ': ' + xhr.responseText));
      }
    };

    xhr.onerror = function(){ reject(new Error('Network error')); };
    xhr.ontimeout = function(){ reject(new Error('Timeout')); };

    xhr.send(formData);
  });
}

// Inicializar estado
resetPreview();
</script>
</body>
</html>
